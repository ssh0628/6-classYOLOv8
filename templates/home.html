<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>{{ title }}</title>
        <style>
            /* 기본 스타일링 */
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
                display: flex;
                justify-content: center;
                align-items: center;
                flex-direction: column;
                background-color: #f4f7f6;
                color: #333;
                min-height: 100vh;
                margin: 0;
            }
            .container {
                background: white;
                padding: 2rem;
                border-radius: 12px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.1);
                text-align: center;
                width: 90%;
                max-width: 500px;
            }
            h1 {
                color: #2c3e50;
            }
            p {
                color: #7f8c8d;
                margin-bottom: 2rem;
            }
            
            /* 폼 요소 스타일 */
            form {
                display: flex;
                flex-direction: column;
                gap: 1.5rem;
            }
            .model-selection, .file-upload {
                border: 2px solid #bdc3c7;
                padding: 1rem;
                border-radius: 8px;
            }
            .model-selection legend, .file-upload legend {
                font-weight: bold;
                padding: 0 0.5rem;
            }
            .radio-group {
                display: flex;
                justify-content: center;
                gap: 2rem;
            }
            input[type="file"] {
                display: none;
            }
            .file-label {
                background-color: #3498db;
                color: white;
                padding: 0.8rem 1.2rem;
                border-radius: 5px;
                cursor: pointer;
                transition: background-color 0.3s;
            }
            .file-label:hover {
                background-color: #2980b9;
            }
            #file-name {
                margin-top: 1rem;
                color: #7f8c8d;
                font-style: italic;
            }
            #image-preview {
                max-width: 100%;
                max-height: 200px;
                margin-top: 1rem;
                border-radius: 8px;
                display: none; /* 기본적으로 숨김 */
                margin: 1.5rem auto 0;
            }
            
            /* 제출 버튼 */
            button {
                padding: 1rem;
                font-size: 1.1rem;
                font-weight: bold;
                color: white;
                background-color: #2ecc71;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                transition: background-color 0.3s;
            }
            button:hover {
                background-color: #27ae60;
            }

            /* 결과 및 로딩 스타일 */
            #result-container {
                margin-top: 2rem;
                padding: 1rem;
                border-radius: 8px;
                background-color: #ecf0f1;
                display: none; /* 기본적으로 숨김 */
            }
            .loader {
                border: 5px solid #f3f3f3;
                border-top: 5px solid #3498db;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                animation: spin 1s linear infinite;
                margin: 1rem auto;
                display: none; /* 기본적으로 숨김 */
            }
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>{{ title }}</h1>
            <p>{{ description }}</p>

            <form id="prediction-form">
                <fieldset class="model-selection">
                    <legend>모델 선택</legend>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="model_type" value="skin" checked> 피부
                        </label>
                        <label>
                            <input type="radio" name="model_type" value="eye"> 눈
                        </label>
                    </div>
                </fieldset>

                <fieldset class="file-upload">
                    <legend>이미지 업로드</legend>
                    <label for="image-file" class="file-label">이미지 파일 선택</label>
                    <input type="file" id="image-file" accept="image/*">
                    <p id="file-name">선택된 파일 없음</p>
                    <img id="image-preview" src="#" alt="Image Preview">
                </fieldset>

                <button type="submit">진단하기</button>
            </form>

            <div id="loader" class="loader"></div>
            <div id="result-container"></div>
        </div>

        <script>
            // 필요한 HTML 요소들을 가져옵니다.
            const form = document.getElementById('prediction-form');
            const imageInput = document.getElementById('image-file');
            const fileNameDisplay = document.getElementById('file-name');
            const imagePreview = document.getElementById('image-preview');
            const loader = document.getElementById('loader');
            const resultContainer = document.getElementById('result-container');

            // 이미지 파일이 선택되면 파일 이름과 미리보기를 업데이트합니다.
            imageInput.addEventListener('change', () => {
                const file = imageInput.files[0];
                if (file) {
                    fileNameDisplay.textContent = file.name;
                    imagePreview.src = URL.createObjectURL(file);
                    imagePreview.style.display = 'block';
                } else {
                    fileNameDisplay.textContent = '선택된 파일 없음';
                    imagePreview.style.display = 'none';
                }
            });

            // "진단하기" 버튼을 눌렀을 때의 동작을 정의합니다.
            form.addEventListener('submit', async (event) => {
                event.preventDefault(); // 폼의 기본 동작(페이지 새로고침)을 막습니다.

                // 1. 사용자 입력 값 가져오기
                const modelType = document.querySelector('input[name="model_type"]:checked').value;
                const imageFile = imageInput.files[0];

                if (!imageFile) {
                    alert('이미지 파일을 선택해주세요.');
                    return;
                }

                // 2. API 요청 준비
                const endpoint = `/${modelType}`; // 요청할 API 주소 (예: /skin 또는 /eye)
                const formData = new FormData();
                formData.append('file', imageFile);

                // 3. 로딩 및 결과 UI 초기화
                loader.style.display = 'block';
                resultContainer.style.display = 'none';
                resultContainer.innerHTML = '';

                // 4. 서버에 API 요청 보내기
                try {
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        body: formData,
                    });

                    if (!response.ok) {
                        throw new Error(`서버 오류: ${response.statusText}`);
                    }

                    const data = await response.json();

                    // 5. 결과 표시
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    const confidence = (parseFloat(data.confidence) * 100).toFixed(2);
                    resultContainer.innerHTML = `
                        <h3>진단 결과</h3>
                        <p><strong>예측 클래스:</strong> ${data.predicted_class}</p>
                        <p><strong>신뢰도:</strong> ${confidence}%</p>
                    `;
                    resultContainer.style.display = 'block';

                } catch (error) {
                    resultContainer.innerHTML = `<p style="color: red;"><strong>오류 발생:</strong> ${error.message}</p>`;
                    resultContainer.style.display = 'block';
                } finally {
                    // 6. 로딩 스피너 숨기기
                    loader.style.display = 'none';
                }
            });
        </script>
    </body>
</html>